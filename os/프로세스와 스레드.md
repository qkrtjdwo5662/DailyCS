# 프로세스와 스레드

태그: OS

### 프로세스

- 실행중인 작업 단위
- 실행파일이 메모리에 적재되어 CPU를 할당받아 실행되는 것
- 즉, 실행중인 프로그램을 의미함
- 실행파일 형태로 존재하던 프로그램이 메모리에 적재되어 CPU에 의해 실행되는 것

### 메모리 적재

- 메모리는 CPU가 직접 접근 할 수 있는 컴퓨터 내부 기억장치임. 프로그램이 CPU에 의해 실행되기 위해서는 메모리에 적재된 상태여야만 함
- 프로세스에 할당되는 메모리 공간은 Code, Data, Stack, Heap 4개의 영역으로 이루어져있음
- 각 프로세스 마다 독립적으로 코드, 데이터, 힙, 스택 영역을 할당을 받는다
    - 코드 : 실행한 프로그램의 코드가 저장되는 메모리 영역
    - 데이터 영역 : 프로그램의 전역변수와 static 변수가 저장되는 메모리 영역
    - 힙 영역 : 개발자가 직접 공간을 할당, 해제 하는 메모리 영역
    - 스택 영역 : 함수 호출 시 생성되는 지역변수, 매개변수가 저장되는 임시 메모리 영역

### CPU 연산

- 프로그램 코드를 바탕으로 CPU가 실제 연산을 해야 프로그램이 실행될 수 있음
- 어떤 코드를 읽어야하는지는 CPU내부에 있는 PC register에 저장되어있음
- 다음에 실행될 코드의 주소 값이 저장되어 PC register가 이를 순차적으로 가리킨다.

### 멀티 프로세스

- 2개 이상의 프로세스가 동시에 실행되는 것을 말함
- 여기서 동시에는 두가지의 의미를 가지고 있음
    - 동시성 : CPU core가 1개일 때, 여러 프로세스를 짧은 시간동안 번갈아 가면서 연산을 수행하게 되는 시분할 시스템으로 실행됨
    - 병렬성 : CPU core가 여러개일 때, 각각의 core가 각각의 process를 연산함으로서 프로세스가 동시에 실행되는 것
    
    → 동시성은 동시에 실행되는 것 처럼 보이고, 병렬성은 실제로 동시에 여러 작업이 수행되는 것을 의미한다.
    
- 멀티 프로세스에서 프로세스는 CPU와 메모리를 공유함
    - 하나의 CPU는 매 순간 하나의 프로세스만 연산할 수 있어서 여러 프로세스들이 매우 빠른속도로 CPU에 번갈아서 실행되는데 이게 사용자 입장에서는 여러 프로그램이 동시에 실행되는 것 처럼 보이는 것임
    - 이렇게 CPU작업 시간을 여러 프로세스들이 조금씩 나누어 쓰는 시스템을 시분할 시스템이라고 함
    - 메모리는 여러 프로세스가 각자의 메모리 영역을 차지하여 동시에 적재된다.
    - 서로 다른 프로세스의 영역을 침범하지 않도록 운영체제가 관리한다.

### 컨텍스트

- 시분할 시스템에서는 한 프로세스가 매우 짧은 시간동안 CPU를 점유해서 일정부분의 명령을 수행하고 다른 프로세스에게 넘기는 과정을 거침
- 그럼 다시 CPU를 점유하면 이전에 어디까지 수행했는지 어떤 상태로 수행되고 있는지 정보가 필요한데 이 정보들이 PCB에 저장됨

### PCB(Process Control Block)

- 운영체제가 프로세스를 표현한 자료구조임
- 프로세스의 중요한 정보가 포함되어있기에 일반 사용자가 접근하지 못하게 보호된 메모리 영역안에 저장됨
- 이 위치는 커널스택인데 보호를 받으면서도 비교적 접근하기가 편리함
- 저장되는 정보로는 프로세스 ID, 프로세스 상태, PC레지스터, CPU 스케줄링, 우선순위, 메모리 정보 등이 있음
- 상태에는 실행, 준비, 봉쇄 세가지 상태로 구분된다.
    - 실행은 프로세스가 CPU를 점유하고 명령을 수행중인 상태
    - 준비 CPU만 할당 받으면 즉시 명령을 수행할 수 있도록 준비된 상태
    - 봉쇄는 CPU를 할당받아도 명령을 실행할 수 없는 상태 - I/O작업을 기다리는 경우를 의미한다.

### 컨텍스트 스위치

- 한 프로세스에서 다른 프로세스로 CPU 제어권을 넘겨주는 것
- 컨텍스트 스위치가 발생하면 이전의 프로세스 상태를 PCB에 저장하여 보관하고, 새로운 프로세스의 PCB를 읽어서 보관된 상태를 복구함

### 스레드

- 스레드는 한 프로세스 내에서 실행되는 동작, 기능 단위이다.
- 스레드는 속해있는 프로세스의 스택 메모리를 제외한 나머지 메모리 영역을 공유할 수 있음
- 스레드는 프로세스 내에서 독립적인 기능을 수행하기에 독립적으로 함수를 호출함
- 그렇기에 스택영역만 따로 할당받는 것임

### 멀티 스레드

- 하나의 프로세스가 동시에 여러개의 일을 수행할 수 있도록 해주는 것
- 하나의 프로세스에서 여러 작업을 병렬로 처리하기 위해 멀티 스레드를 사용함
- 멀티 스레드에서 각각 스레드 마다 PC 레지스터를 가지고 있음 이는 프로세스 내에서도 스레드간 컨텍스트 스위치가 발생하는데 PC 레지스터에 코드 주소가 저장되어 있어야 이어서 실행이 가능하다.

### 멀티 프로세스와 멀티 스레드 비교

- 멀티 스레드는 멀티 프로세스보다 적은 메모리 공간 차지, 컨텍스트 스위치가 빠름
    
    → 캐시 메모리를 초기화할 필요가 없기 때문에
    
- 멀티 프로세스는 멀티 스레드보다 많은 메모리 공간과 CPU 시간을 차지함
- 멀티 스레드는 동시성 문제와 하나의 스레드 문제로 인해 전체 스레드 종료 위험이 있음
- 멀티 프로세스는 하나의 프로세스가 죽어도 다른 프로세스에 영향을 주지 않아 안정성이 높음

⇒ 메모리 구분이 필요한 경우 멀티 프로세스, 컨텍스트 스위칭이 자주 일어나고 데이터 공유가 빈번한 경우는 멀티 스레드를 사용한다.

- 프로세스 통신은 IPC를 통해 통신을 하는데 스레드 간의 통신은 이보다 통신으로 인한 오버헤드가 적다.
- 멀티 프로세스로 구현된 것을 멀티 스레드로 구현하는 경우 메모리 공간, 시스템 자원 소모가 줄어들게 된다.

### IPC

- 멀티 프로세스 환경에서 프로세스 간 데이터를 주고 받는 방식임
- 프로세스는 각각의 독립적인 메모리 공간을 갖기 때문에 이러한 방식을 사용함
- 공유메모리와 메시지 전달 방식이 있음
    - 공유 메모리방식은 프로세스들이 주소 공간의 일부를 공유한다. 초기에 프로세스 공유 메모리 할당을 커널에 요청하고 나서는 일반적인 메모리 접근으로 취급되어 쉽게 메모리 영역에 접근할 수 있음 그렇기에 속도가 빠르다는 장점이 있다.
    - 하지만 동시에 공유 메모리에 접근하면 동시성 문제가 발생할 수 있음 커널이 관여하지 않기때문에 직접 동기화를 적용해야한다.
    - 메시지 전달 방식은 시스템 콜을 사용해서 구현된다. 커널을 통해 send, receive 연산을 수행하여 공유 메모리에 비해 속도가 느리지만 동시성 문제가 발생할 확률은 적다. 그래서 적은양의 데이터를 교환하는데 유리하다.
    - 메시지 전달방식의 예로는 파이프, 소켓, 메시지 큐 등이 있다.