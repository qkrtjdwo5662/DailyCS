# 동시성문제

태그: OS

### 동시성 문제

멀티 프로세스와 멀티 스레드 환경에서는 공유자원에 동시에 접근하여 동시성 문제가 발생할 수 있음

이때 적절한 동기화 기법을 통해 공유자원에 순서대로 접근하게 하여 동시성 문제를 해결할 수 있음

동기화 기법으로는 뮤텍스와 세마포어가 있다.

뮤텍스

- 1개의 스레드 만이 공유자원에 접근하도록 함
- 이를 통해 race condition을 방지하는 기법
- 공유 자원을 접근하는 스레드가 lock을 걸면 다른 스레드는 unlock이 될 때까지 해당 자원에 접근할 수 없도록 함
- 스레드 혹은 프로세스가 임계영역에 들어가기 전에 락을 획득하고 빠져 나갈때 락을 반환한다.

세마포어

- 정해놓은 개수만큼 여러 스레드가 공유 자원에 접근할 수 있도록 제어하는 동기화 기법
- 자원에 접근할때는 wait함수를 통해 세마포의 값을 감소 시키고
- 자원 사용이 끝나면 signal함수를 통해 세마포 값을 증가시킴
- 세마포 값이 0이 되면 모든 자원이 사용 중임을 의미하는 것이고, 자원을 사용하는 프로세스는 세마포 값이 0보다 커질때 까지 block 함
- 바이너리 세마포는 뮤텍스와 같다.

⇒ 뮤텍스와 세마포어의 명확한 차이는 하나의 스레드만 임계영역에 접근가능한지, 여러 스레드가 동시에 접근이 가능한지에 차이가 있다.

⇒ 또한 뮤텍스는 락을 획득한 스레드만이 해제가 가능하지만 세마포어는 누구나 해제 가능하다는 점도 차이점

뮤텍스와 세마포어 등의 동기화 기법에서 락을 관리하는 방식으로 

비지 웨이팅, 블로킹 방식을 사용할 수 있음

블로킹 방식

- 일반적인 락기법의 방식
- 락이 점유된 경우에 CPU를 사용하지 않고 대기 상태로 전환해서 필요할 때 다시 실행하는 방식

비지 웨이팅

- 비지 웨이팅 방식의 락기법을 스핀락이라고 한다.
- 락이 해제될때까지 CPU를 계속 사용하면서 반복적으로 락 상태를 확인하는 방식임

⇒ 락이 빠르게 해제될 가능성이 매우 높은 경우에는 비지 웨이팅이 오히려 성능적으로 유리할 수도 있음

⇒ 하지만 지속해서 CPU를 사용하여 락 상태를 점검하기 때문에 일반적으로 사용하지는 않는다.

### 경쟁상태와 임계영역

우선 race condtion은 공유 자원을 두 개 이상의 프로세스 혹은 스레드가 동시에 읽거나 쓰는 상황을 의미함

임계영역은 경쟁 상태가 발생할 가능성이 있는 코드 영역

경쟁상태를 방지하거나 임계 영역에서 발생할 수 있는 문제를 대비하기 위해서는 적절한 동기화 기법이 필요한데, 여기서 대표적인 동기화 기법이 뮤텍스와 세마포어라고 보면됨

### 교착상태

- 둘 이상의 프로세스 혹은 스레드가 각각 다른 프로세스 혹은 스레드가 점유하고 있는 자원을 서로 기다릴때 무한 대기에 빠지는 상황을 의미함
- 여기서는 그냥 편하게 스레드의 상황만 얘기하겠음
- 데드락이 발생하는 조건은 상호 배제, 점유대기, 비선점, 순환 대기의 이유가 있음
    - 상호 배제 : 하나의 스레드가 자원을 독점하고 있으면 다른 스레드가 자원에 접근이 불가능함
    - 점유 대기 : 스레드가 자원을 보유한 상태에서 다른 스레드가 보유한 자원을 추가로 기다리는 상황
    - 비선점 : 다른 스레드가 사용 중인 자원을 강제로 빼앗 수 없는 상황
    - 순환대기 : 대기 중인 스레드들이 순환 형태로 자원을 대기하고 있는 상황
- 데드락이 발생하면 위 4가지 조건이 모두 발생했다고 볼 수 있음
- 하지만 위 4가지 조건이 모두 발생했다고 해서 데드락이 반드시 발생하는 것은 아님
- 왜? 타임아웃 처럼 일정 시간 후에 특정 조건이 풀리게 되면 데드락은 발생하지 않음
- 데드락을 해결하기 위한 방법
    - 무시 : 데드락이 발생할 가능성이 낮기 때문에 데드락이 발생했을때 아무런 조치를 취하지 않고 그대로 두는 방법
    - 예방 : 교착 상태의 4가지 발생 조건 중 하나가 성립하지 않게 한다.
    - 회피 : 은행원 알고리즘이나 자원할당 그래프 알고리즘을 통해 스레드가 앞으로 자원을 어떻게 요청할지 정보를 통해서 순환 대기 상태가 발생하지 않도록 자원을 할당하는 방법
    - 탐지 회복 : 주기적인 시스템 검사를 통해 데드락 발생을 탐지하고 이를 해결하는 방법이다.