# 데이터베이스 동시성제어

태그: DB

데이터베이스 시스템에서 동시성을 제어하는 방법으로 크게 3가지를 얘기할 수 있음

1. 트랜잭션의 격리수준 조정
2. Lock-Based Concurrency Control(LBCC)
3. Multi-Version Concurrency Control(MVCC)

1번은 개발자가 트랜잭션의 격리수준을 조정하여 동시성을 제어하는 것이고,

2번과 3번은 데이터베이스 시스템 내 스토리지 엔진마다 동시성 제어가 구현이 되어있는 것임

### 트랜잭션 격리수준 조정

트랜잭션 격리 수준은

- READ UNCOMMITTED : 동시성이 가장 뛰어나지만 다른 트랜잭션이 커밋하지 않은 데이터를 읽는 더티 리드가 발생할 수 있다.
- READ COMMITTED : MySQL의 기본값으로, 더티 리드는 발생하지 않지만 Non-Repeatable Read와 Phantom Read는 발생할 수 있음
- REPEATABLE READ : 트랜잭션이 시작될 때 스냅샷을 생성하여 동일한 데이터를 반환하며 Phantom Read는 발생할 수 있음
- SERIALIZABLE : 트랜잭션의 격리수준이 가장 높은 것으로 동시성을 떨어져 성능적으로 좋지는 않지만 안정성은 가장 뛰어남

위에서 언급한 격리 수준에 따른 문제점에 대해 정리해보면

- Dirty-Read : 커밋되지 않은 데이터를 읽기 때문에 롤백 상황에서 문제가 생긴다.
- Non-Repeatable Read : 같은 데이터를 조회했는데 중간에 트랜잭션이 발생해서 값이 바뀌는 경우(수정에 해당)
- Phantom Read : 같은 조건으로 데이터를 조회했는데 새로운 데이터가 추가되거나 삭제되는 경우

지금부터 정리하는 LBCC와 MVCC는 데이터베이스 시스템의 스토리지 엔진에 내부적으로 구현되어있는 데이터베이스 시스템 동시성 제어 기법임

### Lock-Based Concurrency Control(LBCC)

- 데이터에 접근할때 LOCK을 통해 동시성을 제어한다.
- 트랜잭션이 데이터를 읽거나 수정할때 , 데이터에 락을 걸어 다른 트랜잭션의 접근을 차단한다.
- 이 기법에서 사용되는게 공유락과 베타락이다. 읽기 작업은 공유락, 쓰기 작업은 베타락을 사용한다.
- 공유락에서는 여러 트랜잭션이 읽기를 허용하지만 쓰기는 불가능하다.
- 베타락에서는 하나의 트랜잭션만이 데이터를 읽기 혹은 쓰기가 가능하다.

### Multi-Version Concurrency Control(MVCC)

- 트랜잭션이 실행될때마다 새로운 데이터 버전을 생성하여 동시성을 제어하는 기법
- 데이터의 여러 버전을 통해 트랜잭션이 동시에 읽거나 쓸 수 있음
- 트랜잭션이 데이터를 조회할때 해당 트랜잭션의 시작시점의 스냅샷을 읽는다.
- 여러 버전의 데이터를 유지해야하기에 저장 공간이 많이 필요하게 되는 상황이 생길 수는 있지만 읽기 작업 시 락을 사용하지 않아서 성능적으로는 우수하다.

그럼 낙관적락과 비관적락은 무엇인가

위의 세가지는 데이터베이스 시스템 단계에서 동시성을 제어하는 기법임

낙관적락과 비관적락은 어플리케이션 단계에서 동시성을 제어할 수 있는 기법이다.

### 낙관적락

- 데이터 충돌이 자주 발생하지 않는다고 낙관적으로 가정함
- 락을 걸지 않고 데이터 수정 시 기존 값의 변경 여부를 체크하고 업데이트 함
- 보통 버전 번호를 활용한다.

### 비관적락

- 낙관적락과는 다르게 데이터 충돌이 자주 발생한다고 비관적으로 가정하는 것임
- 트랜잭션이 데이터를 조회하는 순간 다른 트랜잭션의 접근을 차단함