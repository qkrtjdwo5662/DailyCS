# 갭락과 넥스트키 락

태그: DB

갭락과 넥스트키 락은 MySQL의 InnoDB에서 팬텀리드를 해결하기 위한 락기법이다.

### 갭락과 넥스트키 락의 등장 배경

- 기존 레코드 락으로는 팬텀리드를 해결할 수 없음
- 팬텀리드는 같은 트랜잭션에서 같은 범위의 데이터를 조회했을 때, 중간에 다른 트랜잭션이 데이터를 추가 또는 삭제하면 조회 결과가 달라지는 문제이다.
- 팬텀리드를 해결하기 위해 갭락과 넥스트키 락이 등장하게 됐음

### 갭락

- 특정 레코드가 아닌 레코드 사이의 범위에 락을 적용한 기법
- 기존 레코드 락 경우 데이터가 없는 경우에는 새로운 데이터 삽입을 막을 수는 없었음
- 이 갭락을 통해 데이터가 없는 일부 범위에 락을 걸 수 있게 됨

```sql
SELECT * 
FROM users 
WHERE age BETWEEN 20 AND 30 
FOR UPDATE;
```

- 특정 레코드 뿐만 아닌 레코드를 포함하는 범위까지 락을 적용할 수 있다.

### 넥스트키 락

- 갭 락 + 레코드 락을 결합한 형태의 락이라고 볼 수 있음
- 특정 레코드의 앞뒤의 갭까지 포함해서 락을 적용한 기법
- 이 갭의 범위는 개발자가 직접 설정할 수 있는 것은 아니며, 인덱스의 순서에 따라 결정된다.
- 범위를 조정하고 싶다면 인덱스를 복합인덱스로 설정하는 것도 방법이 될 수 있음
- 하지만 인덱스를 기반으로 쿼리가 동작하지 않는 경우 넥스트키 락을 설정해도 팬텀리드를 막을 수는 없다.